# OpenIPC Wiki

[Table of Content](../README.md)

可用的安装方法 
==================================

不幸的是，IP 摄像机制造商尚未预装 OpenIPC 的硬件，因此要将 OpenIPC 安装到仍使用工厂固件映像的摄像机上，必须使用以下方法之一：

* [Coupler](https://github.com/openipc/coupler/) 项目提供了固件映像，可以使用许多相机的出厂固件内置的固件升级机制进行安装。

* 使用供应商固件中包含的 [*U Boot* 引导加载程序](https://en.wikipedia.org/wiki/Das_U-Boot) 刷新 OpenIPC 固件。此方法会中断供应商固件的正常启动过程，而是指示 U-Boot 通过网络加载 OpenIPC 固件，并将其写入闪存（替换供应商固件的主要部分）。**此方法需要打开相机外壳**，以将 [**UART 适配器**][FTDI] 连接到相机的内部"控制台"串行/调试端口。


使用 Coupler 安装 OpenIPC 固件。 
--------------------------------------------

关于使用 [Coupler](https://github.com/openipc/coupler/) 的说明可以在 [项目文档](https://github.com/openipc/coupler/) 中找到。

通过 TFTP 和 UART 一步一步安装 OpenIPC 固件。
------------------------------------------------------------

### 步骤 1. 确定片上系统。

SoC 包括摄像头的 CPU 核心，以及所有必要的外围设备，如摄像头和网络接口。由于各种原因（包括大多数 IP 摄像头的板载存储空间有限），OpenIPC 项目目前为每个 SoC 型号构建单独的固件二进制文件。**您必须识别摄像头使用的 SoC**，以便使用正确的固件二进制文件。这可以通过读取摄像头主 PCB 上 SoC IC 封装上的标记来完成（参见下面的示例照片），或者通过使用 [ipctool](https://github.com/openipc/ipctool/) 等软件从供应商固件中识别 SoC 型号来完成。

![SoC 标记](../images/soc-hisilicon.webp) 
![SoC 标记](../images/soc-ingenic-t20.webp) 
![SoC 标记](../images/soc-ingenic-t31.webp) 
![SoC 标记](../images/soc-ingenic-t40.webp)

_Hisilicon Hi3518EV100、Ingenic T20、T31 和 T40 SoC 标记。相关符号以黄色突出显示。_

### 第 2 步. 安装并设置 TFTP 服务器。

TFTP 代表"简单文件传输协议"。顾名思义，它是一种非常简单的协议，用于通过本地计算机网络传输文件。TFTP 不支持身份验证。其代码非常小巧简单，因此 TFTP 客户端广泛用于瘦客户端和嵌入式系统，用于从本地网络上的指定启动服务器检索可启动映像。

#### 如果您有 Linux...

...那么就简单了。您的发行版的预编译和可立即使用的二进制包很可能已经存在于发行版的存储库中，您只需安装并设置它即可。

```bash
sudo apt install tftpd-hpa
sudo sed -i '/^TFTP_OPTIONS/s/"$/ --create"/' /etc/default/tftpd-hpa
sudo systemctl restart tftpd-hpa.service
```

> **注意**：一些用户报告在较新版本的 Ubuntu 上使用 `tftpd-hpa` 时出现问题（连接超时）。在这种情况下，您可以尝试使用 [备用 TFTP 服务器](https://askubuntu.com/a/457105/1074320)。

### 步骤 3. 连接到相机的 UART 端口。

为了连接到 UART 端口，您需要为您的 PC 配备一个 [串行端口适配器][FTDI]。

![UART 模块](../images/uart-module.webp)

__在将该适配器连接到相机之前，请确保其工作电压设置为 3.3 伏！__有时，您只需翻转跳线即可实现这一点。但在某些情况下，您可能需要焊接电线、零欧姆电阻器或用焊料块连接两个触点。有些适配器仅支持 5 伏。在这种情况下，您需要在适配器和相机上的 UART 端口之间连接一个额外的 [逻辑电平转换器][TLLC]。

您需要连接适配器的接触垫之一是 GND（接地）。使用万用表的连续模式很容易发现。将其中一根导线放在众所周知的裸露接地垫上。通常，这些是安装螺丝孔、USB 端口外壳、SD 卡插槽金属壁周围的大型开放式铜接触区域。使用另一根导线轻轻触摸控制垫，直到您看到或听到万用表发出电路闭合的通知。这意味着您找到了接地。现在，您需要找到另外两个：`RX` 和 `TX`，它们分别用于接收和传输数据。从 `TX` 开始。它传输一系列字符，很容易发现。

请注意，您要寻找的是它与地面之间具有 3.3v 电位的触点。使用万用表测试可能的连接点，并标记显示 3.3 伏的点。这样，您就不必测试所有内容，并且可以避免碰到用于红外 LED 阵列等的 12 伏连接器。

将相机上的 `GND` 针脚连接到适配器的 `GND` 焊盘，将适配器的 USB 连接器连接到 PC 上的 USB 端口，启动终端仿真器应用程序并连接到适配器。将终端设置设为 115200 bps 波特率、8 位、无奇偶校验、1 个停止位、无流量控制。

以下是带有会话记录的各种终端程序的几个命令行。选择您要使用的程序。

#### 屏幕

开始会话

```bash
screen -L -Logfile ipcam-$(date +%s).log /dev/ttyUSB0 115200
```

使用"Ctrl-a"后跟"\"退出会话。

#### `minicom`

开始会话

```bash
minicom -b 115200 -8 --capturefile=ipcam-$(date +%s).log --color=on -D /dev/ttyUSB0
```

使用"Ctrl-a"然后按"x"退出会话。

#### `picocom`

开始会话

```bash
picocom -b 115200 --databits 8 --parity n --stopbits 1 --flow n --logfile=ipcam-$(date +%s).log /dev/ttyUSB0
```

使用"Ctrl-a"然后按"Ctrl-x"退出会话。

#### PuTTY

如果你选择 GUI 终端，即 [PuTTY](https://www.putty.org/)，它应该是这样的：

![PuTTY 设置屏幕](https://user-images.githubusercontent.com/29582865/207894192-c6f66401-7715-4aa6-bee2-8343aae6c0a9.png) ![PuTTY 连接屏幕](https://user-images.githubusercontent.com/29582865/209340268-e34a010c-d455-4343-ae83-0866f0f0af15.png)

然后，将适配器上的 `RX` 引脚连接到相机上 UART 端口的可能 `TX` 触点。使用标准电源适配器为相机供电。如果您猜对了，那么您将开始在终端窗口中看到启动日志。在某些情况下，如果您在屏幕上看到乱码文本而不是启动内核，则可能需要将连接速度更改为 57600 bps 并重试。

如果您的屏幕仍然空白，请尝试另一个 UART 联系人，然后再尝试另一个，直到找到正确的联系人。

找到 `TX` 焊盘后，将其连接到适配器上的 `RX` 针脚。是的，这是一个交叉连接。无论传输什么都会进入接收器，反之亦然。现在，将一个重物（铁路螺母、古董锡焊料、一杯伏特加酒（满））放在计算机键盘的任意字母键上，然后开始将适配器剩余的 `TX` 针脚连接到相机上的不同焊盘，直到看到它反馈到终端。事实上，您已成功完成与相机的 UART 连接。现在您可以喝伏特加了。

注意！通常，UART 连接器上有第四个触点，标记为"VCC"。制造商在初始编程期间使用它来为相机供电。我们强烈建议不要通过该引脚为相机供电，而应为此使用 OEM 电源连接器。

### 步骤 4. 访问引导加载程序。

重新启动相机并尝试中断其启动顺序，以便通过在引导加载程序启动和 Linux 内核启动之间按下计算机键盘上的组合键来访问引导加载程序控制台。不同供应商的组合键不同，但在大多数情况下，它是 `Ctrl-C`，不太常见的是 -- `Enter`、`Esc`、`*` 或任何键。仔细阅读启动时屏幕上显示的文本，您可能会在那里看到提示。有些相机需要启动日志中未显示的更奇特的组合。您可以尝试在互联网上查找它们，或在 [我们的 Telegram 频道] [telegram] 上询问。很有可能，我们已经处理过这样的相机并且知道组合。

如果您成功并收到命令提示符，那么恭喜您，您已可以访问相机的引导加载程序。

从现在起，我们强烈建议您记录所做的一切。在终端中启用会话日志记录。更好的方法是，在您的计算机上创建一个文本文件，并写下您运行的所有命令以及系统对它们的响应。

### 步骤 5. 确定闪存大小。

如今，大多数 IP 摄像机都配备了 8 或 16 MB NOR 或 NAND 闪存。您可以在引导加载程序日志输出中检查摄像机上安装的芯片的类型和大小。您会看到类似以下内容：

```console
U-Boot 2010.06-svn (Oct 21 2016 - 11:21:29)

Check Flash Memory Controller v100 ... Found
SPI Nor(cs 0) ID: 0xс2 0x20 0x18
spi_general_qe_enable(294): Error: Disable Quad failed! reg: 0x2
Block:64KB Chip:16MB Name:"MX25L128XX"
SPI Nor total size: 16MB
```

另一个例子：

```console
U-Boot 2013.07 (Feb 27 2019 - 02:05:08)

DRAM:  64 MiB
MMC:   msc: 0
SF: Detected EN25QH64
```

其中显示了闪存型号（`EN25QH64`），您可以在线查找数据表。此外，型号中的`64`表示 64 兆位内存，相当于 8MB。同样，`128`相当于 16MB。

您还应该能够通过查看主板来识别闪存的型号，但这通常是一项艰巨的任务，因为芯片非常小并且可能没有清晰的标记。

### 步骤6. 保存原始固件。

访问引导加载程序控制台后，运行"help"以获取可用命令列表。检查其中是否有"tftp"。如果有，那么保存原始固件应该很容易。您只需从第 2 步设置对 TFTP 服务器的访问权限。

注意！如果您的引导程序没有"tftp"，您仍然可以复制原始固件。[阅读更多]（help-uboot.md）。

使用 `printenv` 命令检查系统环境。查找 `ipaddr`、`netmask`、`gatewayip` 和 `serverip` 参数。前三个设置 IP 地址、摄像机的网络掩码以及用于访问本地网络的网络网关的 IP 地址。第四个参数是 TFTP 服务器的 IP 地址。通过 `setenv` 命令分配值（使用与您的本地网络相对应的 IP 地址和网络掩码），然后使用 `saveenv` 命令将新值保存到环境中。

```bash
setenv ipaddr 192.168.1.253
setenv netmask 255.255.255.0
setenv gatewayip 192.168.1.1
setenv serverip 192.168.1.254
saveenv
```

要转储原始固件，您需要将相机闪存的内容保存到文件中。为此，您必须首先将内容加载到 RAM 中。操作方法如下。初始化闪存。清理 RAM 中一个足够大的区域，以容纳闪存芯片的全部内容。将闪存的内容从该区域读入，然后将其导出到 TFTP 服务器上的文件中。

请注意，不同相机的闪存类型、大小和起始地址有所不同！如需获取确切命令，请使用适用于您硬件的 [自动生成的指令](https://openipc.org/supported-hardware/)、查阅数据表或在 [我们的 Telegram 频道][telegram] 上寻求帮助。

### 步骤 7. 安装 OpenIPC 固件。

#### 前奏。

没有两款相机型号是相同的。不同的相机型号由不同的组件组成。其中最重要的是中央处理器和图像传感器，它们直接影响特定相机的图像质量和固有功能范围。与台式计算机 CPU 不同，相机的处理器处理的功能非常多，因此它有一个特定的名称——片上系统或简称 SoC。

但即便是看似不太重要的组件也会对相机及其固件功能产生限制。例如，不同的相机可能安装了不同的闪存芯片。有些相机可能有 8MB 的闪存，而有些相机可能有 16MB 或更多。更多的闪存可以容纳更多的软件代码，并允许相机运行闪存较少的相机无法提供的附加服务。因此，我们决定构建两个版本的固件：基本版（_Lite_）适用于具有 8MB 闪存的相机，高级版（_Ultimate_）具有附加功能，适用于具有 16MB 闪存的相机。

前面说过，不同相机的固件安装程序有所不同。有不同的内存地址和不同的环境参数，因此在继续之前，请确定相机中的 SoC 类型、传感器、闪存芯片和内存量。

下面我们以 8 MB 闪存的相机为例，介绍如何安装 OpenIPC Lite 固件。即使您的相机有更大的闪存，也不要跳过此文本。请仔细阅读以了解原理和操作顺序。我们将在本节的第二部分提供针对不同相机的特定命令。

#### 准备固件和 TFTP 服务器。

转到 <https://openipc.org/supported-hardware>，在支持的硬件表中找到您的 SoC。确保有该 SoC 的可下载二进制文件。希望有适合您的处理器的预编译固件文件 - 将其下载到您的 PC 上。

如果您按照步骤 2 操作，那么您将拥有自己的 TFTP 服务器，该服务器从 `/srv/tftp` 目录提供文件。将您刚刚下载的软件包中的文件提取到该目录中。

```bash
sudo tar -C /srv/tftp/ -xvf openipc.*.tgz
```

#### 准备相机闪光。

因此，我们有一只豚鼠，一个带有 hi3518ev100 SoC 的相机，配备 OV9712 传感器、64 MB RAM 和 8MB NOR 闪存。

通过 UART 端口连接到相机并访问引导加载程序控制台。将组件参数设置为适当的环境变量。设置用于加载 Linux 内核和新固件的根文件系统的环境变量。设置相机访问本地网络的环境变量，其中 `ethaddr` 是原始相机 MAC 地址，`ipaddr` 是相机在网络上的 IP 地址，`gatewayip` 是用于访问网络的路由器的 IP 地址，`netmask` 是子网掩码，`serverip` 是步骤 3 中的 TFTP 服务器的 IP 地址。将更新的值保存到闪存。

对于确切的命令，请使用针对您的硬件的[自动生成的指令](https://openipc.org/supported-hardware/)、查阅数据表或在[我们的 Telegram 频道][telegram] 上寻求帮助。

#### 安装。

对于确切的命令，请使用针对您的硬件的[自动生成的指令](https://openipc.org/supported-hardware/)、查阅数据表或在[我们的 Telegram 频道][telegram] 上寻求帮助。

注意！请注意终端屏幕上的消息！如果任何命令出现错误，请找出问题所在。也许你打错了？无论如何，在所有之前的命令都成功之前，不要继续该过程。否则，你可能会得到一个坏掉的相机！

### 步骤 8. 首次启动。

如果所有前面的步骤都正确完成，您的相机应该会从新固件开始。欢迎使用 OpenIPC！

使用新固件首次启动后，您需要清理覆盖分区。在终端窗口中运行以下命令：

```bash
firstboot
```

[logo]: ../images/logo_openipc.png
[FTDI]: https://www.google.com/search?q=ftdi+usb+ttl
[TLLC]: https://google.com/search?q=logic+level+converter+3.3v+5v
[telegram]: https://t.me/OpenIPC
